{% extends 'base.html' %}

{% block title %}AirSense - Weather & Pollen Tracker{% endblock %}

{% block content %}
    <div class="container">
        <h1>AirSense</h1>
        <p>Weather & Pollen Tracker</p>
        
        <div class="weather-section">
            <h2>Weather Forecast</h2>
            
            <div id="currentCityName"></div>
            
            <div class="current-weather">
                <div id="current-temp">--°C</div>
                <div id="current-condition">Loading...</div>
                <div id="current-humidity">Humidity: --%</div>
            </div>
            
            <div class="day-selector">
                <div class="day-bar" id="dayBar"></div>
            </div>
            
            <div class="daily-weather">
                <div id="daily-temp">Max: --°C | Min: --°C</div>
                <div id="daily-condition">--</div>
            </div>
            
            <div class="hourly-weather">
                <h3>Hourly Forecast</h3>
                <table id="hourly-table">
                    <thead>
                        <tr>
                            <th>Hour</th>
                            <th>Temperature</th>
                            <th>Condition</th>
                        </tr>
                    </thead>
                    <tbody id="hourly-container"></tbody>
                </table>
            </div>
        </div>
        
        <div class="pollen-forecast-section">
            <h2>Pollen Forecast</h2>
            
            <div class="pollen-controls">
                <input type="date" id="pollenDateSelect">
                <div class="pollen-day-bar" id="pollenDayBar"></div>
            </div>
            
            <div class="hourly-pollen">
                <h3>Hourly Pollen Forecast</h3>
                <table id="pollen-hourly-table">
                    <thead>
                        <tr>
                            <th>Hour</th>
                            <th>Alder</th>
                            <th>Birch</th>
                            <th>Grass</th>
                            <th>Mugwort</th>
                            <th>Olive</th>
                            <th>Ragweed</th>
                        </tr>
                    </thead>
                    <tbody id="pollen-hourly-container"></tbody>
                </table>
            </div>
        </div>
        
        <div class="pollen-section">
            <h2>Pollen Allergies</h2>
            <form id="pollenForm">
                <div class="pollen-checkboxes">
                    <label><input type="checkbox" name="pollens" value="alder" {% if 'alder' in user_allergies %}checked{% endif %}> Alder Pollen</label>
                    <label><input type="checkbox" name="pollens" value="birch" {% if 'birch' in user_allergies %}checked{% endif %}> Birch Pollen</label>
                    <label><input type="checkbox" name="pollens" value="grass" {% if 'grass' in user_allergies %}checked{% endif %}> Grass Pollen</label>
                    <label><input type="checkbox" name="pollens" value="mugwort" {% if 'mugwort' in user_allergies %}checked{% endif %}> Mugwort Pollen</label>
                    <label><input type="checkbox" name="pollens" value="olive" {% if 'olive' in user_allergies %}checked{% endif %}> Olive Pollen</label>
                    <label><input type="checkbox" name="pollens" value="ragweed" {% if 'ragweed' in user_allergies %}checked{% endif %}> Ragweed Pollen</label>
                </div>
            </form>
        </div>
        
        <div class="feeling-section">
            <h2>How do you feel today?</h2>
            <form id="feelingForm" onsubmit="return handleFormSubmit(event)">
                {% csrf_token %}
                <textarea id="feelingText" placeholder="Describe how you feel today..."></textarea>
                <button type="submit">Analyze</button>
            </form>
            <div id="sentimentResult"></div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const weatherData = {{ weather_data|safe }};
        const pollenData = {{ pollen_data|safe }};
        const userAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        
        function handleFormSubmit(event) {
            event.preventDefault();
            console.log('Form submitted via inline handler');
            
            const feelingText = document.getElementById('feelingText').value;
            const selectedPollens = Array.from(document.querySelectorAll('input[name="pollens"]:checked')).map(cb => cb.value);
            
            if (!feelingText.trim()) {
                alert('Please describe how you feel today.');
                return false;
            }
            
            const formData = new FormData();
            formData.append('feeling', feelingText);
            selectedPollens.forEach(pollen => formData.append('pollens', pollen));
            
            fetch('/api/sentiment/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('sentimentResult');
                if (data.sentiment) {
                    const sentimentClass = data.sentiment.toLowerCase() === 'positive' ? 'sentiment-positive' : 
                                         data.sentiment.toLowerCase() === 'negative' ? 'sentiment-negative' : 'sentiment-neutral';
                    
                    resultDiv.innerHTML = `
                        <div class="${sentimentClass}">
                            Sentiment: ${data.sentiment} (${Math.round(data.confidence * 100)}% confidence)
                            <br>Selected allergies: ${data.selected_pollens.join(', ') || 'None'}
                            <br><br><strong>Recommendation:</strong><br>${data.recommendation}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="sentiment-neutral">Error analyzing sentiment</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('sentimentResult').innerHTML = '<div class="sentiment-neutral">Error analyzing sentiment</div>';
            });
            
            return false;
        }
    </script>
    <script src="/static/core/js/home.js"></script>
{% endblock %}